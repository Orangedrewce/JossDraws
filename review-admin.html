<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin | Review Link Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }

        .is-hidden { display: none !important; }

        :root {
            --color-bg: #f9f9f9;
            --color-card: #ffffff;
            --color-white: #ffffff;
            --color-black: #000000;
            --color-text: #333;
            --text-muted: #666;
            --text-muted-soft: #999;
            --text-muted-strong: #555;

            --color-muted: var(--text-muted);
            --color-muted-2: var(--text-muted-soft);
            --color-muted-3: var(--text-muted-strong);
            --color-border: #ddd;
            --color-border-soft: #eee;
            --color-border-strong: #ddd;

            --color-surface-2: #f9f9f9;
            --color-surface-3: #f5f5f5;

            --color-primary: #000000;
            --color-primary-hover: #333;
            --color-primary-light: #f5f5f5;

            --color-success: #10b981;
            --color-success-hover: #059669;
            --color-success-dark: #065f46;
            --color-success-bg: #ecfdf5;

            --color-info: #3b82f6;
            --color-info-hover: #2563eb;

            --color-danger: #ef4444;
            --color-danger-bg: #fef2f2;
            --color-danger-text: #991b1b;
            --color-danger-hover: #dc2626;

            --color-warning: #f59e0b;
            --color-warning-dark: #b45309;
            --color-warning-bg: #fffbeb;

            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 12px;
            --radius-pill: 100px;

            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 15px rgba(0,0,0,0.05);
            --shadow-xl: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        body { 
            font-family: system-ui, -apple-system, sans-serif;
            padding: 2rem; 
            max-width: 620px; 
            margin: 0 auto; 
            background: var(--color-bg);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .card { 
            background: var(--color-card); 
            padding: 2.5rem; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border-soft);
        }
        
        h1 { 
            margin: 0 0 0.25rem 0;
            font-size: 1.5rem;
            letter-spacing: -0.02em;
            color: var(--color-text);
        }
        
        .description {
            text-align: center;
            color: var(--text-muted);
            margin: 0;
            font-size: 0.95rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }
        
        select, button { 
            width: 100%; 
            font-size: 1rem;
        }
        
        select { 
            padding: 0.75rem; 
            margin-bottom: 1.25rem; 
            border: 1px solid var(--color-border-strong); 
            border-radius: var(--radius-md);
            background: var(--color-white);
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--color-text);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }
        
        select:hover {
            border-color: var(--color-primary);
        }
        
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.08);
        }
        
        button { 
            background: var(--color-primary); 
            color: var(--color-white); 
            border: none; 
            padding: 0.9rem 2rem; 
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer; 
            border-radius: var(--radius-md); 
            transition: background 0.2s, box-shadow 0.2s;
            letter-spacing: 0.01em;
        }
        
        button:hover:not(:disabled) { 
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
        }
        
        button:active:not(:disabled) {
            box-shadow: none;
        }
        
        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }
        
        #resultArea { 
            margin-top: 1.5rem; 
            padding: 1.5rem; 
            background: var(--color-success-bg); 
            border: 1px solid var(--color-success); 
            border-radius: var(--radius-md);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-label {
            font-weight: 600;
            color: var(--color-success-dark);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .link-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        input.link-box { 
            flex: 1;
            padding: 0.7rem 0.85rem; 
            font-size: 0.9rem; 
            border: 1px solid var(--color-success); 
            background: var(--color-white); 
            border-radius: var(--radius-md);
            font-family: 'SF Mono', SFMono-Regular, ui-monospace, Menlo, Consolas, monospace;
            color: var(--color-text);
        }

        input.link-box:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }
        
        .copy-btn {
            padding: 0.7rem 1.4rem;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        .copy-btn:hover {
            background: var(--color-success-hover);
        }
        
        .copy-btn.copied {
            background: var(--color-success-dark);
        }
        
        .info-text { 
            font-size: 0.85rem; 
            color: var(--text-muted-strong); 
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .source-tag {
            display: inline-block;
            background: var(--color-white);
            border: 1px solid var(--color-success);
            padding: 0.3rem 0.85rem;
            border-radius: var(--radius-pill);
            font-size: 0.8rem;
            margin-top: 0.75rem;
            font-weight: 600;
            color: var(--color-success-dark);
        }
        
        .error-message {
            background: var(--color-danger-bg);
            border: 1px solid var(--color-danger);
            color: var(--color-danger-text);
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-top: 1rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-pill);
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .status-badge.healthy {
            background: var(--color-success-bg);
            color: var(--color-success-dark);
        }
        
        .status-badge.warning {
            background: var(--color-warning-bg);
            color: var(--color-warning-dark);
        }
        
        .expiration-info {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        .recent-links {
            margin-top: 2rem;
            padding: 1.25rem;
            background: var(--color-surface-2);
            border-radius: var(--radius-md);
        }

        .links-sentinel {
            padding: 0.75rem 0;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted-soft);
        }

        .links-sentinel strong {
            color: var(--color-text);
        }
        
        .recent-links-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .recent-links-title {
            font-weight: 600;
            color: var(--color-text);
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
            background: transparent;
            border: none;
            padding: 0.25rem 0;
            text-align: left;
            flex: 1;
        }
        
        .recent-links-title:hover {
            color: var(--color-text);
        }

        .recent-links-title:hover:not(:disabled),
        .recent-links-title:active:not(:disabled) {
            background: transparent;
            box-shadow: none;
        }

        .filter-hint {
            font-size: 0.8rem;
            color: var(--text-muted-soft);
            font-style: italic;
            margin-bottom: 1rem;
            padding: 0;
        }
        
        .expand-arrow {
            transition: transform 0.3s;
            font-size: 1rem;
        }
        
        .expand-arrow.collapsed {
            transform: rotate(-90deg);
        }
        
        .link-item {
            background: var(--color-white);
            padding: 1rem 1.1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.6rem;
            border: 1px solid var(--color-border);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .link-item:hover {
            border-color: var(--color-border-strong);
            box-shadow: var(--shadow-sm);
        }
        
        .link-item-header {
            display: flex;
            justify-content: flex-start;
            align-items: baseline;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .link-item-header .link-item-date {
            margin-left: auto;
        }
        
        .link-item-source {
            font-weight: 600;
            color: var(--color-text);
        }
        
        .link-item-date {
            font-size: 0.72rem;
            color: var(--text-muted-soft);
        }
        
        .link-item-url {
            font-family: 'SF Mono', SFMono-Regular, ui-monospace, Menlo, Consolas, monospace;
            font-size: 0.75rem;
            color: var(--text-muted-soft);
            background: var(--color-surface-3);
            padding: 0.4rem 0.65rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.6rem;
            line-height: 1.4;
            overflow: visible;
            text-overflow: clip;
            white-space: normal;
            overflow-wrap: anywhere;
        }

        .link-item-url-field {
            width: 100%;
            border: 1px solid var(--color-border-soft);
            outline: none;
            cursor: text;
            user-select: text;
        }

        textarea.link-item-url-field {
            display: block;
            resize: vertical;
            min-height: 2.4em;
        }

        .link-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .link-item-status {
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted-soft);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.9rem;
        }
        
        .link-item-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        
        .mini-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.78rem;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .mini-btn:hover {
            background: var(--color-success-hover);
        }
        
        .mini-btn.secondary {
            background: var(--color-info);
        }
        
        .mini-btn.secondary:hover {
            background: var(--color-info-hover);
        }

        .mini-btn.danger {
            background: transparent;
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
        }

        .mini-btn.danger:hover {
            background: var(--color-danger);
            color: white;
        }
        
        .source-name {
            background: transparent;
            border: none;
            padding: 0;
            font: inherit;
            line-height: inherit;
            font-weight: 600;
            color: var(--color-text);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            font-size: 0.9rem;
            text-align: left;
        }
        
        .source-name:hover {
            color: var(--color-info);
        }
        
        .source-name::after {
            content: ' ‚Ä∫';
            font-size: 0.85rem;
            opacity: 0.4;
            font-weight: 400;
        }
        
        .filter-badge {
            display: inline-block;
            background: var(--color-primary);
            color: white;
            padding: 0.2rem 0.65rem;
            border-radius: var(--radius-pill);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .clear-filter {
            background: var(--color-danger);
            cursor: pointer;
            margin-left: 0.5rem;
            transition: background 0.2s;
        }

        .clear-filter:hover {
            background: var(--color-danger-hover);
        }

        button:focus-visible,
        select:focus-visible,
        .source-name:focus-visible,
        .mini-btn:focus-visible,
        .recent-links-title:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .text-success { color: var(--color-success); }
        .text-info { color: var(--color-info); }
        .text-warning { color: var(--color-warning); }
        .text-danger { color: var(--color-danger); }
        .text-muted { color: var(--text-muted); }
        .text-muted-2 { color: var(--text-muted-soft); }

        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: system-ui;
            color: var(--text-muted);
            background: var(--color-bg);
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
            padding: 2rem;
        }

        .auth-screen.auth-screen--danger {
            color: var(--color-danger-text);
        }

        .divider {
            height: 1px;
            background: var(--color-border-soft);
            margin: 1.5rem 0;
            border: none;
        }

        /* ====== RESPONSIVE / MOBILE ====== */
        @media (max-width: 640px) {
            body {
                padding: 0.75rem;
            }

            .card {
                padding: 1.25rem 1rem;
                border-radius: var(--radius-md);
            }

            h1 {
                font-size: 1.25rem;
            }

            .description {
                font-size: 0.85rem;
            }

            select, button {
                font-size: 1rem;
                -webkit-appearance: none;
                appearance: none;
            }

            select {
                padding: 0.85rem 2.5rem 0.85rem 0.75rem;
            }

            button {
                padding: 0.85rem 1.5rem;
            }

            .link-container {
                flex-direction: column;
            }

            .copy-btn {
                width: 100%;
                padding: 0.75rem;
                text-align: center;
            }

            input.link-box {
                font-size: 0.8rem;
                width: 100%;
            }

            #resultArea {
                padding: 1rem;
            }

            .recent-links {
                padding: 0.85rem;
            }

            .link-item {
                padding: 0.85rem;
            }

            .link-item-header {
                flex-wrap: wrap;
                gap: 0.35rem;
            }

            .link-item-header .link-item-date {
                margin-left: 0;
                width: 100%;
            }

            .link-item-url {
                font-size: 0.7rem;
                word-break: break-all;
            }

            textarea.link-item-url-field {
                min-height: 3em;
                font-size: 0.72rem;
            }

            .link-item-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .link-item-actions {
                width: 100%;
            }

            .mini-btn {
                flex: 1;
                text-align: center;
                padding: 0.45rem 0.5rem;
                min-height: 36px;
            }

            .source-name {
                font-size: 0.85rem;
            }

            .auth-screen {
                padding: 1.5rem;
            }

            /* Settings inputs */
            #settingsSection input[type="password"] {
                font-size: 1rem;
                padding: 0.7rem 0.75rem;
            }
        }

        @media (max-width: 380px) {
            body {
                padding: 0.5rem;
            }

            .card {
                padding: 1rem 0.75rem;
            }

            h1 {
                font-size: 1.1rem;
            }

            .mini-btn {
                font-size: 0.72rem;
                padding: 0.4rem 0.4rem;
            }

            .link-item-actions {
                flex-wrap: wrap;
            }
        }

    </style>
</head>
<body>
    <main class="card">
        <div class="card-header">
            <h1>Review Invite Generator</h1>
            <p class="description">Create secure, one-time review links for customers</p>
        </div>

        <form id="generatorForm">
            <label for="sourceSelect">Select Source Type</label>
            <select id="sourceSelect" name="source">
            </select>

            <button id="generateBtn" type="submit">
                Generate Link
            </button>
        </form>

        <div id="errorMessage" class="error-message is-hidden"></div>

        <div id="resultArea" class="is-hidden">
            <div class="result-label">üìß Send this link to your customer:</div>
            <div class="link-container">
                <input 
                    type="text" 
                    id="linkOutput" 
                    class="link-box" 
                    readonly 
                >
                <button 
                    id="copyBtn" 
                    class="copy-btn" 
                    type="button"
                >
                    Copy
                </button>
            </div>
            <div class="source-tag" id="sourceTag"></div>
        </div>

        <!-- Performance Stats Removed (Redundant) -->

        <hr class="divider is-hidden" id="linksDivider">

        <div class="recent-links is-hidden" id="recentLinksContainer">
            <div class="recent-links-title-row">
                <button type="button" class="recent-links-title" id="recentLinksToggle" aria-expanded="false" aria-controls="recentLinks">
                    <span id="recentLinksTitle">Generated Links</span>
                    <span class="expand-arrow collapsed" id="expandArrow">‚ñº</span>
                </button>
                <button type="button" class="filter-badge clear-filter is-hidden" id="clearFilterBtn" title="Clear filter">‚úñ Clear</button>
            </div>
            <div id="recentLinks" class="is-hidden">
                <p class="filter-hint">Tap a source name to filter by type</p>
                <div id="recentLinksList"></div>
                <div id="recentLinksSentinel" class="links-sentinel"></div>
            </div>
        </div>

        <div class="empty-state is-hidden" id="emptyState">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-text">No links generated yet</div>
        </div>

        <hr class="divider" id="settingsDivider">

        <details class="recent-links" id="settingsSection">
            <summary style="cursor:pointer; font-weight:600; font-size:0.95rem; color:var(--color-text); list-style:none; display:flex; justify-content:space-between; align-items:center; padding:0.25rem 0;">
                <span>‚öôÔ∏è Settings</span>
                <span style="font-size:0.8rem; opacity:0.4;">‚ñº</span>
            </summary>
            <div style="margin-top:1rem;">
                <label for="currentCodeInput" style="font-size:0.85rem;">Current Admin Code</label>
                <input type="password" id="currentCodeInput" placeholder="Current code" style="width:100%; padding:0.6rem 0.75rem; margin-bottom:0.75rem; border:1px solid var(--color-border-strong); border-radius:var(--radius-md); font-size:0.9rem;">
                <label for="newCodeInput" style="font-size:0.85rem;">New Admin Code</label>
                <input type="password" id="newCodeInput" placeholder="New code (min 4 characters)" style="width:100%; padding:0.6rem 0.75rem; margin-bottom:0.75rem; border:1px solid var(--color-border-strong); border-radius:var(--radius-md); font-size:0.9rem;">
                <label for="confirmCodeInput" style="font-size:0.85rem;">Confirm New Code</label>
                <input type="password" id="confirmCodeInput" placeholder="Re-enter new code" style="width:100%; padding:0.6rem 0.75rem; margin-bottom:1rem; border:1px solid var(--color-border-strong); border-radius:var(--radius-md); font-size:0.9rem;">
                <button type="button" id="changeCodeBtn" style="background:var(--color-warning); width:100%;">Change Admin Code</button>
                <div id="changeCodeMessage" class="is-hidden" style="margin-top:0.75rem; padding:0.75rem; border-radius:var(--radius-md); font-size:0.85rem; font-weight:500;"></div>
            </div>
        </details>
    </main>

    <script>
        // ============================================
        // DEMO TRACE LOGGER
        // ============================================
        const Trace = (() => {
            let step = 0;

            function time() {
                return new Date().toISOString().split('T')[1].replace('Z', '');
            }

            function log(event, data = null) {
                step += 1;
                const id = String(step).padStart(2, '0');
                const prefix = `[${id} | ${time()}] ${event}`;
                if (data !== null && data !== undefined) {
                    console.log(prefix, data);
                } else {
                    console.log(prefix);
                }
            }

            function group(label) {
                console.group(`‚ñ∂ ${label}`);
            }

            function groupEnd() {
                console.groupEnd();
            }

            return { log, group, groupEnd };
        })();

        Trace.log('APP_INIT');

        // ============================================
        // ACCESS GUARD (server-side verified)
        // ============================================
        // The admin code is sent to Postgres on every action and
        // verified against a bcrypt hash. Even if someone reads this
        // source code, they cannot do anything without the real code.
        // ============================================
        let adminCode = null;
        {
            Trace.group('ACCESS_GUARD');
            const MAX_ATTEMPTS = 3;
            for (let attempt = 0; attempt < MAX_ATTEMPTS; attempt++) {
                const input = prompt('Enter admin code:');
                if (input === null) break;
                if (input && input.trim().length > 0) {
                    adminCode = input.trim();
                    break;
                }
            }

            if (!adminCode) {
                Trace.log('AUTH_NO_INPUT');
                Trace.groupEnd();
                document.body.innerHTML = '<div class="auth-screen auth-screen--danger"><h2>Access Denied</h2><p>No admin code provided.</p></div>';
                throw new Error('Access denied');
            }

            Trace.log('AUTH_CODE_RECEIVED');
            Trace.groupEnd();
        }

        Trace.log('PAGE_LOADED');

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SUPABASE_URL: 'https://pciubbwphwpnptgawgok.supabase.co',
            SUPABASE_KEY: 'sb_publishable_jz1pWpo7TDvURxQ8cqP06A_xc4ckSwv',
            SITE_URL: 'https://orangedrewce.github.io/JossDraws/review.html',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000
        };

        const DEFAULT_SOURCE_KEY = 'general';
        const SOURCES = {
            commission: { emoji: 'üé®', label: 'Commission' },
            etsy: { emoji: 'üõçÔ∏è', label: 'Etsy Order' },
            print: { emoji: 'üñ®Ô∏è', label: 'Art Print' },
            sticker: { emoji: 'üè∑Ô∏è', label: 'Sticker' },
            bookmark: { emoji: 'üîñ', label: 'Bookmark' },
            pet_portrait: { emoji: 'üêæ', label: 'Pet Portrait' },
            faceless_portrait: { emoji: 'üë§', label: 'Faceless Portrait' },
            coloring_book: { emoji: 'üñçÔ∏è', label: 'Coloring Book' },
            general: { emoji: 'üìã', label: 'General' }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        // DOM Elements
        const elements = {
            form: document.getElementById('generatorForm'),
            btn: document.getElementById('generateBtn'),
            sourceSelect: document.getElementById('sourceSelect'),
            resultArea: document.getElementById('resultArea'),
            linkOutput: document.getElementById('linkOutput'),
            sourceTag: document.getElementById('sourceTag'),
            copyBtn: document.getElementById('copyBtn'),
            errorMessage: document.getElementById('errorMessage'),
            recentLinksContainer: document.getElementById('recentLinksContainer'),
            linksDivider: document.getElementById('linksDivider'),
            emptyState: document.getElementById('emptyState'),
            recentLinksToggle: document.getElementById('recentLinksToggle'),
            clearFilterBtn: document.getElementById('clearFilterBtn'),
            recentLinks: document.getElementById('recentLinks'),
            recentLinksList: document.getElementById('recentLinksList'),
            recentLinksSentinel: document.getElementById('recentLinksSentinel'),
            recentLinksTitle: document.getElementById('recentLinksTitle'),
            expandArrow: document.getElementById('expandArrow')
        };

        let db;
        try {
            db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
            Trace.log('DB_CONNECTED');
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
            Trace.log('DB_CONNECTION_FAILED', { message: error?.message || String(error) });
            showError('Failed to connect to database. Please refresh the page.');
            if (elements.btn) elements.btn.disabled = true;
        }
        
        const state = {
            filter: null,
            links: {
                expanded: false,
                pageSize: 20,
                offset: 0,
                hasMore: true,
                loading: false,
                queryKey: 0,
                observer: null
            }
        };

        // Delete confirmation state
        const DELETE_CONFIRM_MS = 3000;
        const pendingDeletes = new Map();

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        /**
         * Validates that a source value is non-empty and safe
         */
        function validateSource(source) {
            if (!source || typeof source !== 'string') {
                return { valid: false, error: 'Please select a valid source type' };
            }
            
            const trimmed = source.trim();
            if (trimmed.length === 0) {
                return { valid: false, error: 'Source cannot be empty' };
            }

            const key = trimmed.toLowerCase();
            if (!/^[a-z0-9_]+$/.test(key)) {
                return { valid: false, error: 'Invalid source type selected' };
            }

            if (!Object.prototype.hasOwnProperty.call(SOURCES, key)) {
                return { valid: false, error: 'Invalid source type selected' };
            }

            return { valid: true, value: key };
        }

        /**
         * Sanitizes text for display (prevents XSS)
         */
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setHidden(el, hidden) {
            if (!el) return;
            el.classList.toggle('is-hidden', Boolean(hidden));
        }

        /**
         * Shows error message to user
         */
        let errorTimer = null;
        function showError(message) {
            if (errorTimer) clearTimeout(errorTimer);
            elements.errorMessage.textContent = message;
            setHidden(elements.errorMessage, false);

            errorTimer = setTimeout(() => {
                setHidden(elements.errorMessage, true);
                errorTimer = null;
            }, 5000);
        }
        /**
         * Hides error message
         */
        function hideError() {
            if (errorTimer) {
                clearTimeout(errorTimer);
                errorTimer = null;
            }
            setHidden(elements.errorMessage, true);
        }

        /**
         * Updates button state
         */
        function setButtonState(isLoading) {
            const LOADING_LABEL = '‚è≥ Generating...';
            const DEFAULT_LABEL = 'Generate Link';
            if (isLoading) {
                elements.btn.disabled = true;
                elements.btn.textContent = LOADING_LABEL;
            } else {
                elements.btn.disabled = false;
                if (elements.btn.textContent === LOADING_LABEL) {
                    elements.btn.textContent = DEFAULT_LABEL;
                }
            }
        }

        function normalizeSourceKey(source) {
            const value = String(source ?? DEFAULT_SOURCE_KEY).trim().toLowerCase();
            if (!/^[a-z0-9_]+$/.test(value)) return DEFAULT_SOURCE_KEY;
            return Object.prototype.hasOwnProperty.call(SOURCES, value) ? value : DEFAULT_SOURCE_KEY;
        }

        function getSourceMeta(source) {
            const key = normalizeSourceKey(source);
            return SOURCES[key] || SOURCES[DEFAULT_SOURCE_KEY];
        }

        function populateSourceSelect() {
            if (!elements.sourceSelect) return;

            const previousRaw = elements.sourceSelect.value;
            const previous = normalizeSourceKey(previousRaw);
            const fragment = document.createDocumentFragment();
            for (const [key, meta] of Object.entries(SOURCES)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = `${meta.emoji} ${meta.label}`;
                fragment.appendChild(opt);
            }
            elements.sourceSelect.replaceChildren(fragment);

            if (previousRaw && Object.prototype.hasOwnProperty.call(SOURCES, previous)) {
                elements.sourceSelect.value = previous;
            } else if (Object.prototype.hasOwnProperty.call(SOURCES, 'commission')) {
                elements.sourceSelect.value = 'commission';
            } else {
                elements.sourceSelect.value = DEFAULT_SOURCE_KEY;
            }
        }

        /**
         * Returns a formatted display label with emoji for a source key
         */
        function formatSourceLabel(source) {
            const meta = getSourceMeta(source);
            return `${meta.emoji} ${meta.label}`;
        }

        /**
         * Gets the display label for a select option
         */
        function getSelectedLabel() {
            return formatSourceLabel(elements.sourceSelect.value);
        }

        /**
         * Retry wrapper for database operations
         */
        async function withRetry(operation, retries = CONFIG.MAX_RETRIES) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (i + 1)));
                }
            }
        }

        // ============================================
        // CORE FUNCTIONALITY
        // ============================================

        /**
         * Generates a new review link token
         */
        async function generateLink() {
            Trace.group('GENERATE_LINK_FLOW');
            Trace.log('GENERATE_CLICK', { source: elements.sourceSelect?.value || null });
            hideError();

            if (!db) {
                Trace.log('GENERATE_ABORT_NO_DB');
                showError('Database not connected. Please refresh the page.');
                Trace.groupEnd();
                return;
            }
            
            // 1. Validate source selection
            const sourceValidation = validateSource(elements.sourceSelect.value);
            if (!sourceValidation.valid) {
                Trace.log('VALIDATION_FAILED', { error: sourceValidation.error });
                showError(sourceValidation.error);
                Trace.groupEnd();
                return;
            }

            const selectedSource = sourceValidation.value;
            const selectedLabel = getSelectedLabel();

            setButtonState(true);

            try {
                // 2. Create token via server-side admin function (bcrypt-verified)
                Trace.log('RPC_CREATE_START', { source: selectedSource });

                const { data: rpcResult, error } = await withRetry(async () => {
                    return await db.rpc('admin_create_token', {
                        p_admin_code: adminCode,
                        p_source: selectedSource
                    });
                });

                if (error) {
                    Trace.log('RPC_CREATE_ERROR', { message: error.message || 'Failed to create token' });
                    throw new Error(error.message || 'Failed to create token');
                }

                if (!rpcResult || !rpcResult.success) {
                    const errMsg = rpcResult?.error || 'Failed to create token';
                    Trace.log('RPC_CREATE_DENIED', { error: errMsg });
                    if (errMsg === 'Unauthorized') {
                        adminCode = null;
                        document.body.innerHTML = '<div class="auth-screen auth-screen--danger"><h2>Access Denied</h2><p>Invalid admin code.</p></div>';
                        return;
                    }
                    throw new Error(errMsg);
                }

                const data = rpcResult.token;
                if (!data || !data.id) {
                    Trace.log('RPC_CREATE_BAD_RESPONSE');
                    throw new Error('Invalid response from server');
                }

                Trace.log('RPC_CREATE_SUCCESS', { tokenId: data.id });

                // 3. Construct and validate URL
                const fullLink = `${CONFIG.SITE_URL}?token=${encodeURIComponent(data.id)}`;
                Trace.log('LINK_BUILT', { url: fullLink });
                
                // Verify URL is valid
                try {
                    new URL(fullLink);
                } catch (e) {
                    Trace.log('LINK_INVALID');
                    throw new Error('Generated invalid URL');
                }

                // 4. Display result
                elements.linkOutput.value = fullLink;
                elements.sourceTag.textContent = `Source: ${selectedLabel}`;
                setHidden(elements.resultArea, false);

                Trace.log('UI_RENDER_RESULT');
                

                // Check if expiration info needs to be cleared (since we removed the feature)
                const existingExpiration = elements.resultArea.querySelector('.expiration-info');
                if (existingExpiration) {
                    existingExpiration.remove();
                }

                
                // Auto-select the link for easy copying
                elements.linkOutput.select();
                
                // Update button text
                elements.btn.textContent = 'Generate Another';

                // Refresh page data after creating new link
                // - clear filters so the new link is visible
                // - reset infinite scroll paging so newest items load first
                state.filter = null;
                if (elements.clearFilterBtn) {
                    setHidden(elements.clearFilterBtn, true);
                }
                resetRecentLinksPaging();
                Trace.log('RECENT_LINKS_REFRESH');
                await loadRecentLinks();

                // Optionally expand links so the new item is visible
                if (!state.links.expanded) {
                    toggleLinksSection();
                }

                Trace.log('GENERATE_DONE', { tokenId: data.id, source: selectedSource });

            } catch (error) {
                console.error('Error generating link:', error);
                Trace.log('GENERATE_FAILED', { message: error?.message || String(error) });
                showError(`Failed to generate link: ${error.message}`);
            } finally {
                setButtonState(false);
                Trace.groupEnd();
            }
        }

        /**
         * Copies link to clipboard
         */
        async function copyToClipboard() {
            const link = elements.linkOutput.value;
            
            if (!link) {
                showError('No link to copy');
                return;
            }

            try {
                Trace.log('COPY_TO_CLIPBOARD', { link });
                // Modern clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(link);
                } else {
                    // Fallback for older browsers
                    elements.linkOutput.select();
                    document.execCommand('copy');
                }

                // Visual feedback
                const originalText = elements.copyBtn.textContent;
                elements.copyBtn.textContent = '‚úì Copied!';
                elements.copyBtn.classList.add('copied');

                Trace.log('COPY_SUCCESS');

                setTimeout(() => {
                    elements.copyBtn.textContent = originalText;
                    elements.copyBtn.classList.remove('copied');
                }, 2000);

            } catch (error) {
                console.error('Copy failed:', error);
                Trace.log('COPY_FAILED', { message: error?.message || String(error) });
                showError('Failed to copy link. Please select and copy manually.');
            }
        }


        /**
         * Loads and displays recent links
         */
        async function loadRecentLinks(filterSource = null) {
            Trace.group('LOAD_RECENT_LINKS');
            Trace.log('FETCH_START', {
                filter: filterSource,
                offset: state.links.offset,
                pageSize: state.links.pageSize,
                queryKey: state.links.queryKey
            });
            try {
                if (!db) return;
                if (state.links.loading) return;

                state.links.loading = true;

                const queryKey = state.links.queryKey;
                const startOffset = state.links.offset;

                if (elements.recentLinksSentinel) {
                    elements.recentLinksSentinel.textContent = 'Loading‚Ä¶';
                }

                let query = db
                    .from('tokens')
                    .select('id, source, created_at, expires_at, is_used')
                    .order('created_at', { ascending: false })
                    .range(startOffset, startOffset + state.links.pageSize - 1);
                
                if (filterSource) {
                    query = query.eq('source', filterSource);
                }
                
                const { data, error } = await query;

                // If filter/reset happened while awaiting, ignore this response
                if (queryKey !== state.links.queryKey) {
                    Trace.log('FETCH_IGNORED_STALE', { expected: state.links.queryKey, got: queryKey });
                    return;
                }

                if (error) {
                    console.error('Recent links error:', error);
                    Trace.log('FETCH_ERROR', { message: error?.message || String(error) });
                    return;
                }

                Trace.log('FETCH_SUCCESS', { count: data?.length || 0 });

                const isFirstPage = startOffset === 0;
                if (isFirstPage) {
                    if (!data || data.length === 0) {
                        setHidden(elements.recentLinksContainer, true);
                        setHidden(elements.linksDivider, true);
                        setHidden(elements.emptyState, false);
                        if (elements.recentLinksSentinel) elements.recentLinksSentinel.textContent = '';
                        state.links.hasMore = false;
                        return;
                    }
                    setHidden(elements.recentLinksContainer, false);
                    setHidden(elements.linksDivider, false);
                    setHidden(elements.emptyState, true);
                }

                // Update title with filter if applicable
                if (filterSource) {
                    // Clear existing content and rebuild with filter badge
                    elements.recentLinksTitle.textContent = `${formatSourceLabel(filterSource)} Links`;

                    if (elements.clearFilterBtn) {
                        setHidden(elements.clearFilterBtn, false);
                    }
                } else {
                    if (elements.clearFilterBtn) {
                        setHidden(elements.clearFilterBtn, true);
                    }
                    elements.recentLinksTitle.textContent = 'Generated Links';
                }

                // Build links display (DOM nodes, no innerHTML)
                const now = new Date();
                const fragment = document.createDocumentFragment();
                for (const link of (data || [])) {
                    fragment.appendChild(renderLinkItem(link, now));
                }

                if (elements.recentLinksList) {
                    if (isFirstPage) {
                        elements.recentLinksList.replaceChildren(fragment);
                    } else {
                        elements.recentLinksList.appendChild(fragment);
                    }
                }

                // Update pagination state (offset-stable)
                state.links.offset = startOffset + (data?.length || 0);
                state.links.hasMore = (data?.length || 0) === state.links.pageSize;

                Trace.log('FETCH_RENDERED', { offset: state.links.offset, hasMore: state.links.hasMore });

                if (elements.recentLinksSentinel) {
                    if (state.links.hasMore) {
                        elements.recentLinksSentinel.textContent = 'Loading more‚Ä¶';
                    } else {
                        elements.recentLinksSentinel.textContent = 'End of list';
                    }
                }

                ensureLinksObserver();

            } catch (error) {
                console.error('Failed to load recent links:', error);
                Trace.log('FETCH_FAILED', { message: error?.message || String(error) });
            } finally {
                state.links.loading = false;
                Trace.groupEnd();
            }
        }

        function resetRecentLinksPaging() {
            state.links.queryKey++;
            state.links.offset = 0;
            state.links.hasMore = true;
            state.links.loading = false;
            if (elements.recentLinksList) elements.recentLinksList.textContent = '';
            if (elements.recentLinksSentinel) elements.recentLinksSentinel.textContent = '';

            if (state.links.observer) {
                try { state.links.observer.disconnect(); } catch { /* noop */ }
                state.links.observer = null;
            }
        }

        function ensureLinksObserver() {
            if (!elements.recentLinksSentinel) return;
            if (state.links.observer) return;

            state.links.observer = new IntersectionObserver((entries) => {
                const entry = entries[0];
                if (!entry || !entry.isIntersecting) return;
                if (!state.links.expanded) return;
                if (!db) return;
                if (!state.links.hasMore) return;

                loadRecentLinks(state.filter).catch(() => {});
            }, {
                root: null,
                rootMargin: '300px 0px',
                threshold: 0
            });

            state.links.observer.observe(elements.recentLinksSentinel);
        }

        function computeStatusText(link, now) {
            const expiresDate = new Date(link.expires_at);
            const isExpired = expiresDate < now;

            if (link.is_used) return '‚úÖ Used';
            if (isExpired) return '‚ö†Ô∏è Expired';

            const msRemaining = expiresDate - now;
            const daysRemaining = Math.ceil(msRemaining / (1000 * 60 * 60 * 24));
            return `üîµ Active (${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} left)`;
        }

        function renderLinkItem(link, now) {
            const fullLink = `${CONFIG.SITE_URL}?token=${encodeURIComponent(link.id)}`;
            const createdDate = new Date(link.created_at);
            const expiresDate = new Date(link.expires_at);
            const isExpired = expiresDate < now;

            const item = document.createElement('div');
            item.className = 'link-item';

            const header = document.createElement('div');
            header.className = 'link-item-header';

            const sourceBtn = document.createElement('button');
            sourceBtn.className = 'source-name';
            sourceBtn.type = 'button';
            sourceBtn.dataset.action = 'filter';
            sourceBtn.dataset.source = normalizeSourceKey(link.source);
            sourceBtn.title = 'Filter by this source';
            sourceBtn.textContent = formatSourceLabel(link.source);

            const dateStr = createdDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const timeStr = createdDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const dateTimeStr = `${dateStr} at ${timeStr}`;

            const dateSpan = document.createElement('span');
            dateSpan.className = 'link-item-date';
            dateSpan.title = dateTimeStr;
            dateSpan.textContent = `${dateStr} ‚Ä¢ ${timeStr}`;

            header.append(sourceBtn, dateSpan);

            const urlRow = document.createElement('textarea');
            urlRow.className = 'link-item-url link-item-url-field';
            urlRow.readOnly = true;
            urlRow.rows = 2;
            urlRow.value = fullLink;
            urlRow.spellcheck = false;

            const footer = document.createElement('div');
            footer.className = 'link-item-footer';

            const status = document.createElement('span');
            status.className = 'link-item-status text-muted';
            status.textContent = computeStatusText(link, now);

            const actions = document.createElement('div');
            actions.className = 'link-item-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'mini-btn';
            copyBtn.type = 'button';
            copyBtn.dataset.action = 'copy';
            copyBtn.dataset.link = fullLink;
            copyBtn.textContent = 'Copy Link';
            actions.appendChild(copyBtn);

            if (!link.is_used && !isExpired) {
                const testBtn = document.createElement('button');
                testBtn.className = 'mini-btn secondary';
                testBtn.type = 'button';
                testBtn.dataset.action = 'test';
                testBtn.dataset.link = fullLink;
                testBtn.textContent = 'Test';
                actions.appendChild(testBtn);
            }

            const delBtn = document.createElement('button');
            delBtn.className = 'mini-btn danger';
            delBtn.type = 'button';
            delBtn.dataset.action = 'delete';
            delBtn.dataset.id = link.id;
            delBtn.textContent = 'Delete';
            actions.appendChild(delBtn);

            footer.append(status, actions);

            item.append(header, urlRow, footer);
            return item;
        }

        function armDeleteConfirmation(tokenId) {
            const existingTimeout = pendingDeletes.get(tokenId);
            if (existingTimeout) {
                clearTimeout(existingTimeout);
            }
            const timeoutId = setTimeout(() => {
                pendingDeletes.delete(tokenId);
            }, DELETE_CONFIRM_MS);
            pendingDeletes.set(tokenId, timeoutId);
        }

        async function deleteToken(tokenId, buttonEl) {
            Trace.group('DELETE_FLOW');
            Trace.log('DELETE_CLICK', { tokenId });
            if (!db) {
                Trace.log('DELETE_ABORT_NO_DB');
                showError('Database not connected. Please refresh the page.');
                Trace.groupEnd();
                return;
            }

            // Two-click confirm (console-only)
            if (!pendingDeletes.has(tokenId)) {
                armDeleteConfirmation(tokenId);
                Trace.log('DELETE_CONFIRM_ARMED', { ttlMs: DELETE_CONFIRM_MS });
                Trace.groupEnd();
                return;
            }

            // Confirmed
            const timeoutId = pendingDeletes.get(tokenId);
            if (timeoutId) clearTimeout(timeoutId);
            pendingDeletes.delete(tokenId);

            const originalText = buttonEl?.textContent;
            if (buttonEl) {
                buttonEl.disabled = true;
                buttonEl.textContent = 'Deleting...';
            }

            try {
                Trace.log('RPC_DELETE_START');
                const { data: delResult, error } = await db.rpc('admin_delete_token', {
                    p_admin_code: adminCode,
                    p_token_id: String(tokenId)
                });

                if (error) {
                    throw new Error(error.message || 'Delete failed');
                }

                if (!delResult || !delResult.success) {
                    const errMsg = delResult?.error || 'Delete failed';
                    if (errMsg === 'Unauthorized') {
                        adminCode = null;
                        document.body.innerHTML = '<div class="auth-screen auth-screen--danger"><h2>Access Denied</h2><p>Invalid admin code.</p></div>';
                        return;
                    }
                    throw new Error(errMsg);
                }

                Trace.log('DELETE_SUCCESS');

                // Interlock: Hide result area if the deleted token is currently displayed
                // We check if the current link output contains the deleted token ID
                if (elements.resultArea && !elements.resultArea.classList.contains('is-hidden')) {
                    const currentLink = elements.linkOutput.value;
                    if (currentLink && currentLink.includes(tokenId)) {
                        setHidden(elements.resultArea, true);
                        elements.linkOutput.value = '';
                    }
                }

                // Refresh list and source performance to keep paging consistent
                resetRecentLinksPaging();
                await loadRecentLinks(state.filter);

            } catch (err) {
                console.error('Delete failed:', err);
                Trace.log('DELETE_FAILED', { message: err?.message || String(err) });
                showError(`Failed to delete link: ${err.message}`);
            } finally {
                if (buttonEl) {
                    buttonEl.disabled = false;
                    buttonEl.textContent = originalText || 'Delete';
                }

                Trace.groupEnd();
            }
        }
        
        /**
         * Copies a link to clipboard
         */
        async function copyLinkToClipboard(link) {
            try {
                Trace.log('COPY_RECENT_LINK', { link });
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(link);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = link;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    textarea.setAttribute('aria-hidden', 'true');
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                Trace.log('COPY_RECENT_LINK_SUCCESS');
            } catch (error) {
                console.error('Copy failed:', error);
                Trace.log('COPY_RECENT_LINK_FAILED', { message: error?.message || String(error) });
            }
        }
        
        /**
         * Opens a link in new tab
         */
        function openLink(link) {
            Trace.log('USER_OPEN_TEST_LINK', { link });
            window.open(link, '_blank', 'noopener,noreferrer');
        }
        
        /**
         * Filters links by source
         */
        function filterBySource(source) {
            const normalized = normalizeSourceKey(source);
            state.filter = normalized;
            Trace.log('FILTER_APPLIED', { source: normalized });
            resetRecentLinksPaging();
            loadRecentLinks(normalized);

            // Unify filtering UX: expand the Recent Links panel when filtering
            if (!state.links.expanded) {
                state.links.expanded = true;
                setHidden(elements.recentLinks, false);
                elements.expandArrow.classList.toggle('collapsed', false);
                if (elements.recentLinksToggle) {
                    elements.recentLinksToggle.setAttribute('aria-expanded', 'true');
                }
            }
        }
        
        /**
         * Clears the source filter
         */
        function clearFilter() {
            state.filter = null;
            Trace.log('FILTER_CLEARED');
            resetRecentLinksPaging();
            loadRecentLinks();
        }
        
        /**
         * Toggles the links section visibility
         */
        function toggleLinksSection() {
            state.links.expanded = !state.links.expanded;
            Trace.log('LINKS_TOGGLED', { expanded: state.links.expanded });
            setHidden(elements.recentLinks, !state.links.expanded);
            elements.expandArrow.classList.toggle('collapsed', !state.links.expanded);

            if (elements.recentLinksToggle) {
                elements.recentLinksToggle.setAttribute('aria-expanded', String(state.links.expanded));
            }

            if (state.links.expanded) {
                ensureLinksObserver();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        populateSourceSelect();

        if (elements.form) {
            elements.form.addEventListener('submit', (e) => {
                e.preventDefault();
                generateLink();
            });
        } else {
            elements.btn.addEventListener('click', generateLink);
        }
        elements.copyBtn.addEventListener('click', copyToClipboard);

        if (elements.recentLinksToggle) {
            elements.recentLinksToggle.addEventListener('click', () => {
                Trace.log('USER_TOGGLE_SECTION_CLICK');
                toggleLinksSection();
            });
        }

        if (elements.clearFilterBtn) {
            elements.clearFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                Trace.log('USER_CLEAR_FILTER_CLICK');
                clearFilter();
            });
        }

        // Allow Enter key on select to generate
        elements.sourceSelect.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                generateLink();
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================

        Trace.log('UI_READY');

        // Verify admin code server-side, then load data
        if (db) {
            (async () => {
                try {
                    Trace.log('AUTH_SERVER_VERIFY_START');
                    const { data, error } = await db.rpc('verify_admin', { p_admin_code: adminCode });
                    if (error || !data || !data.success) {
                        Trace.log('AUTH_SERVER_DENIED');
                        adminCode = null;
                        document.body.innerHTML = '<div class="auth-screen auth-screen--danger"><h2>Access Denied</h2><p>Invalid admin code.</p></div>';
                        return;
                    }
                    Trace.log('AUTH_SERVER_VERIFIED');
                } catch (e) {
                    // Network error ‚Äî allow proceeding, individual RPCs will catch invalid codes
                    console.warn('Admin verification network error:', e);
                }
                resetRecentLinksPaging();
                loadRecentLinks();
            })();
        }

        // Handle page visibility changes (refresh stats when page becomes visible)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && db) {
                resetRecentLinksPaging();
                loadRecentLinks(state.filter);
            }
        });

        // ============================================
        // CHANGE ADMIN CODE
        // ============================================
        {
            const changeBtn = document.getElementById('changeCodeBtn');
            const currentInput = document.getElementById('currentCodeInput');
            const newInput = document.getElementById('newCodeInput');
            const confirmInput = document.getElementById('confirmCodeInput');
            const changeMsg = document.getElementById('changeCodeMessage');

            function showChangeMsg(text, isError) {
                changeMsg.textContent = text;
                changeMsg.style.background = isError ? 'var(--color-danger-bg)' : 'var(--color-success-bg)';
                changeMsg.style.color = isError ? 'var(--color-danger-text)' : 'var(--color-success-dark)';
                changeMsg.style.border = `1px solid ${isError ? 'var(--color-danger)' : 'var(--color-success)'}`;
                setHidden(changeMsg, false);
            }

            if (changeBtn) {
                changeBtn.addEventListener('click', async () => {
                    setHidden(changeMsg, true);
                    const currentVal = currentInput.value.trim();
                    const newVal = newInput.value.trim();
                    const confirmVal = confirmInput.value.trim();

                    if (!currentVal) { showChangeMsg('Enter your current admin code.', true); return; }
                    if (newVal.length < 4) { showChangeMsg('New code must be at least 4 characters.', true); return; }
                    if (newVal !== confirmVal) { showChangeMsg('New codes do not match.', true); return; }
                    if (newVal === currentVal) { showChangeMsg('New code must be different from current code.', true); return; }

                    changeBtn.disabled = true;
                    changeBtn.textContent = 'Changing...';

                    try {
                        const { data, error } = await db.rpc('admin_change_code', {
                            p_current_code: currentVal,
                            p_new_code: newVal
                        });

                        if (error) throw new Error(error.message);
                        if (!data || !data.success) {
                            const errMsg = data?.error || 'Change failed';
                            showChangeMsg(errMsg, true);
                            return;
                        }

                        // Update in-memory admin code so subsequent actions use the new one
                        adminCode = newVal;
                        currentInput.value = '';
                        newInput.value = '';
                        confirmInput.value = '';
                        showChangeMsg('Admin code changed successfully!', false);
                        Trace.log('ADMIN_CODE_CHANGED');
                    } catch (err) {
                        showChangeMsg('Failed: ' + err.message, true);
                    } finally {
                        changeBtn.disabled = false;
                        changeBtn.textContent = 'Change Admin Code';
                    }
                });
            }
        }

        // Event Delegation for generated links
        if (elements.recentLinksList) {
            elements.recentLinksList.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                const action = btn.getAttribute('data-action');
                if (!action) return;

                if (action === 'copy') {
                    const link = btn.getAttribute('data-link');
                    if (link) copyLinkToClipboard(link);
                } else if (action === 'test') {
                    const link = btn.getAttribute('data-link');
                    Trace.log('USER_TEST_CLICK', { link });
                    if (link) openLink(link);
                } else if (action === 'delete') {
                    const id = btn.getAttribute('data-id');
                    if (id) deleteToken(id, btn);
                } else if (action === 'filter') {
                    const source = btn.getAttribute('data-source');
                    Trace.log('USER_FILTER_CLICK', { source });
                    if (source) filterBySource(source);
                }
            });

            elements.recentLinksList.addEventListener('dblclick', (e) => {
                const field = e.target.closest('.link-item-url-field');
                if (!field) return;
                field.focus();
                field.select();
                Trace.log('USER_URL_DBLCLICK', { url: field.value });
            });
        }


    </script>
</body>
</html>